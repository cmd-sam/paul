<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>paul</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;1,300&family=DM+Sans:wght@300;400;500&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #F2EDE6;
    --surface: #FAF6F0;
    --border: #E2D9CF;
    --text: #1C1916;
    --muted: #A89E93;
    --accent: #5C8A3C;
    --accent-light: #EBF3E4;
    --msg-paul-bg: #FBF7F2;
    --msg-user-bg: #B5705A;
    --msg-user-text: #FDF6F3;
    --warm: #D4845A;
    --paul-label: #C4795A;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .topbar {
    display: flex;
    align-items: center;
    padding: 14px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    gap: 12px;
    position: relative;
    z-index: 10;
  }

  .topbar-back {
    text-decoration: none;
    color: var(--muted);
    font-size: 18px;
    flex-shrink: 0;
    transition: color 0.15s;
  }
  .topbar-back:hover { color: var(--text); }

  .topbar-title {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .topbar-paul {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 300;
    letter-spacing: 0.2em;
    color: var(--warm);
    opacity: 0.6;
    flex-shrink: 0;
  }

  .summary-btn {
    background: var(--accent-light);
    border: 1px solid rgba(92,138,60,0.25);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--accent);
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
  }
  .summary-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
  .summary-btn.updating { opacity: 0.5; pointer-events: none; }
  .summary-btn.open { background: var(--accent); color: white; border-color: var(--accent); }

  .summary-btn .arrow {
    font-size: 9px;
    transition: transform 0.3s ease;
    display: inline-block;
  }
  .summary-btn.open .arrow { transform: rotate(180deg); }

  /* ---- SUMMARY DROPDOWN ---- */
  .summary-dropdown {
    background: var(--accent-light);
    border-bottom: 1px solid rgba(92,138,60,0.12);
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.25s ease,
                box-shadow 0.25s ease;
    opacity: 0;
    flex-shrink: 0;
    position: relative;
    z-index: 9;
  }

  .summary-dropdown.open {
    max-height: 55vh;
    opacity: 1;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    overflow-y: auto;
  }

  .summary-dropdown-inner { padding: 16px 20px 20px; }

  .summary-meta {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    color: var(--accent);
    opacity: 0.4;
    margin-bottom: 14px;
  }

  .summary-section { margin-bottom: 14px; }

  .summary-section-title {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    font-weight: 300;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    opacity: 0.6;
    margin-bottom: 6px;
  }

  .summary-item {
    font-size: 13px;
    color: #2E4A1E;
    line-height: 1.55;
    padding: 5px 0;
    border-bottom: 1px solid rgba(92,138,60,0.1);
  }
  .summary-item:last-child { border-bottom: none; }

  .summary-empty {
    font-size: 13px;
    color: var(--accent);
    opacity: 0.4;
    font-family: 'DM Mono', monospace;
    font-weight: 300;
  }

  /* ---- CHAT ---- */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .msg {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.55;
    animation: fadeUp 0.2s ease;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg-user {
    align-self: flex-end;
    background: var(--msg-user-bg);
    color: var(--msg-user-text);
    border-bottom-right-radius: 4px;
  }

  .msg-paul {
    align-self: flex-start;
    background: var(--msg-paul-bg);
    border: 1px solid var(--border);
    color: var(--text);
    border-bottom-left-radius: 4px;
  }

  .msg-paul .msg-sender {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    font-weight: 300;
    color: var(--paul-label);
    opacity: 0.7;
    margin-bottom: 4px;
    letter-spacing: 0.1em;
  }

  .msg-loading {
    opacity: 0.4;
    font-style: italic;
    font-size: 13px;
  }

  /* ---- INPUT ---- */
  .chat-input-wrap {
    padding: 12px 20px 16px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .chat-input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  .chat-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    resize: none;
    outline: none;
    color: var(--text);
    line-height: 1.5;
    max-height: 100px;
    transition: border-color 0.15s;
  }

  .chat-input::placeholder { color: var(--muted); }
  .chat-input:focus { border-color: var(--warm); }

  .send-btn {
    background: var(--warm);
    border: none;
    border-radius: 10px;
    width: 40px;
    height: 40px;
    cursor: pointer;
    color: white;
    font-size: 16px;
    flex-shrink: 0;
    transition: opacity 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .send-btn:hover { opacity: 0.85; }
  .send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<div class="topbar">
  <a href="vorhaben.html" class="topbar-back">←</a>
  <span class="topbar-title" id="topbar-title">–</span>
  <span class="topbar-paul">paul</span>
  <button class="summary-btn" id="summary-btn" onclick="summaryToggle()">
    stand <span class="arrow">▼</span>
  </button>
</div>

<div class="summary-dropdown" id="summary-dropdown">
  <div class="summary-dropdown-inner">
    <div class="summary-meta" id="summary-meta"></div>
    <div id="summary-content">
      <div class="summary-empty">noch keine zusammenfassung.</div>
    </div>
  </div>
</div>

<div class="chat-area" id="chat-area"></div>

<div class="chat-input-wrap">
  <div class="chat-input-row">
    <textarea class="chat-input" id="chat-input" rows="1"
      placeholder="gedanken, hinweise, offene fragen …"
      onkeydown="handleKey(event)"
      oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="send-btn" onclick="senden()">↑</button>
  </div>
</div>

<script src="api.js"></script>
<script src="app.js"></script>
<script>
  const params = new URLSearchParams(window.location.search);
  const AKTUELLE_PROJEKT_ID = params.get('vorhaben') || 'standard';
  const INAKTIVITAET_MS = 2 * 60 * 1000;
  let inaktivitaetTimer = null;
  let summaryOffen = false;

  async function start() {
    await init();

    const projekte = projekteHolen();
    const name = projekte[AKTUELLE_PROJEKT_ID]?.name || 'vorhaben';
    document.getElementById('topbar-title').textContent = name;

    const alte = nachrichtenHolen(AKTUELLE_PROJEKT_ID);
    if (alte.length === 0) {
      nachrichtAnzeigen('paul', 'hallo. was liegt an?');
    } else {
      alte.forEach(m => {
        const typ = m.role === 'user' ? 'user' : 'paul';
        nachrichtAnzeigen(typ, m.content, false);
      });
    }

    const projekt = projekte[AKTUELLE_PROJEKT_ID];
    if (projekt?.zusammenfassung) {
      zusammenfassungAnzeigen(projekt.zusammenfassung);
      if (projekt.zusammenfassungZeit) summaryMetaAktualisieren(projekt.zusammenfassungZeit);
    }
  }

  function summaryToggle() {
    summaryOffen = !summaryOffen;
    document.getElementById('summary-dropdown').classList.toggle('open', summaryOffen);
    document.getElementById('summary-btn').classList.toggle('open', summaryOffen);
  }

  function nachrichtAnzeigen(typ, text, animieren = true) {
    const chatArea = document.getElementById('chat-area');
    const div = document.createElement('div');
    div.className = 'msg msg-' + typ;
    if (!animieren) div.style.animation = 'none';

    if (typ === 'paul') {
      div.innerHTML = '<div class="msg-sender">paul</div>' + escHtml(text);
    } else {
      div.textContent = text;
    }

    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
    return div;
  }

  async function senden() {
    const input = document.getElementById('chat-input');
    const btn = document.getElementById('send-btn');
    const text = input.value.trim();
    if (!text) return;

    nachrichtAnzeigen('user', text);
    input.value = '';
    input.style.height = '';

    btn.disabled = true;
    const loading = nachrichtAnzeigen('paul', '…');
    loading.classList.add('msg-loading');

    try {
      const antwort = await nachrichtSenden(AKTUELLE_PROJEKT_ID, text);
      loading.remove();
      nachrichtAnzeigen('paul', antwort);
    } catch (e) {
      loading.remove();
      nachrichtAnzeigen('paul', 'verbindungsfehler. api key prüfen.');
      btn.disabled = false;
      return;
    }

    btn.disabled = false;
    inaktivitaetTimerReset();
  }

  function inaktivitaetTimerReset() {
    if (inaktivitaetTimer) clearTimeout(inaktivitaetTimer);
    inaktivitaetTimer = setTimeout(async () => {
      const btn = document.getElementById('summary-btn');
      btn.classList.add('updating');
      try {
        const zusammenfassung = await zusammenfassungAktualisieren(AKTUELLE_PROJEKT_ID);
        if (zusammenfassung) {
          zusammenfassungAnzeigen(zusammenfassung);
          const jetzt = Date.now();
          const projekte = projekteHolen();
          if (projekte[AKTUELLE_PROJEKT_ID]) {
            projekte[AKTUELLE_PROJEKT_ID].zusammenfassungZeit = jetzt;
            projekteSpeichern(projekte);
          }
          summaryMetaAktualisieren(jetzt);
        }
      } catch (e) {
        console.log('zusammenfassung fehler:', e);
      }
      btn.classList.remove('updating');
    }, INAKTIVITAET_MS);
  }

  function summaryMetaAktualisieren(timestamp) {
    const el = document.getElementById('summary-meta');
    const d = new Date(timestamp);
    const uhrzeit = d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    el.textContent = 'stand ' + uhrzeit;
  }

  function zusammenfassungAnzeigen(text) {
    const { hinweise, offen } = zusammenfassungParsen(text);
    const el = document.getElementById('summary-content');
    let html = '';

    if (hinweise.length) {
      html += '<div class="summary-section">';
      html += '<div class="summary-section-title">hinweise</div>';
      hinweise.forEach(h => html += `<div class="summary-item">${escHtml(h)}</div>`);
      html += '</div>';
    }

    if (offen.length) {
      html += '<div class="summary-section">';
      html += '<div class="summary-section-title">offen</div>';
      offen.forEach(o => html += `<div class="summary-item">${escHtml(o)}</div>`);
      html += '</div>';
    }

    if (!html) html = '<div class="summary-empty">noch keine zusammenfassung.</div>';
    el.innerHTML = html;
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      senden();
    }
  }

  function autoResize(el) {
    el.style.height = '';
    el.style.height = Math.min(el.scrollHeight, 100) + 'px';
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  start();
</script>
</body>
</html>